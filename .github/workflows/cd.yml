---
    name: ğŸš€ CD - Continuous Deployment
    
    "on":
      workflow_run:
        workflows: ["ğŸ” CI - Continuous Integration"]
        types:
          - completed
        branches: [Firman]
      push:
        branches: [Firman]
        paths:
          - 'App/**'
          - 'Model/**'
          - 'requirements.txt'
          - 'README_SPACES.md'
    
    env:
      PYTHON_VERSION: '3.11'
      HF_SPACE_NAME: 'Tugas1MLOps'
    
    jobs:
      deploy:
        name: ğŸš€ Deploy to Hugging Face Spaces
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    
        steps:
          - name: ğŸ“¥ Checkout Code
            uses: actions/checkout@v4
            with:
              fetch-depth: 0
    
          - name: ğŸ Set up Python
            uses: actions/setup-python@v4
            with:
              python-version: ${{ env.PYTHON_VERSION }}
    
          - name: ğŸ“¦ Install Dependencies
            run: |
              python -m pip install --upgrade pip
              pip install huggingface_hub
              pip install -r requirements.txt
    
          - name: ğŸ” Validate Model Files
            run: |
              echo "ğŸ” Validating model files before deployment..."
              if [ ! -f "Model/personality_classifier.skops" ]; then
                echo "âŒ Model file not found! Running training..."
                python train.py
              fi
              if [ ! -f "Model/label_encoder.skops" ]; then
                echo "âŒ Label encoder not found!"
                exit 1
              fi
              if [ ! -f "Model/feature_names.skops" ]; then
                echo "âŒ Feature names not found!"
                exit 1
              fi
              echo "âœ… All model files validated successfully"
    
          - name: ğŸ§ª Test App Locally
            run: |
              echo "ğŸ§ª Testing Gradio app locally..."
              timeout 30s python App/app.py || echo "App test completed"
    
          - name: ğŸ“‹ Prepare Deployment Files
            run: |
              echo "ğŸ“‹ Preparing files for Hugging Face Spaces..."
              cp App/app.py app.py
              if [ ! -f "README.md" ]; then
                cp README_SPACES.md README.md
              fi
              echo "âœ… Files prepared for deployment:"
              ls -la app.py
              ls -la requirements.txt
              ls -la Model/
    
          - name: ğŸ”‘ Configure Git
            run: |
              git config --global user.email "github-actions@github.com"
              git config --global user.name "GitHub Actions Bot"
    
          - name: ğŸš€ Deploy to Hugging Face Spaces
            env:
              HF_TOKEN: ${{ secrets.HF_TOKEN }}
            run: |
              echo "ğŸš€ Starting deployment to Hugging Face Spaces..."
              if [ -z "$HF_TOKEN" ]; then
                echo "âš ï¸ HF_TOKEN not found in secrets"
                echo "ğŸ”§ Manual deployment required"
                exit 0
              fi
              python -c "
              from huggingface_hub import HfApi, login
              import os
              login(token=os.environ['HF_TOKEN'])
              print('âœ… Successfully logged in to Hugging Face')
              "
              cat > deploy_script.py << 'EOF'
              from huggingface_hub import HfApi
              import os
              import sys
              
              def main():
                  api = HfApi()
                  token = os.environ.get('HF_TOKEN')
                  space_name = os.environ.get('HF_SPACE_NAME')
                  
                  if not token:
                      print('âŒ HF_TOKEN not found')
                      sys.exit(1)
                      
                  try:
                      space_info = api.space_info(space_name, token=token)
                      print(f'âœ… Space {space_name} exists, updating...')
                      
                      api.upload_file(
                          path_or_fileobj='app.py',
                          path_in_repo='app.py',
                          repo_id=space_name,
                          repo_type='space',
                          token=token
                      )
                      
                      api.upload_file(
                          path_or_fileobj='requirements.txt',
                          path_in_repo='requirements.txt',
                          repo_id=space_name,
                          repo_type='space',
                          token=token
                      )
                      
                      api.upload_folder(
                          folder_path='Model/',
                          path_in_repo='Model',
                          repo_id=space_name,
                          repo_type='space',
                          token=token
                      )
                      
                      print(f'âœ… Successfully updated Space: {space_name}')
                      
                  except Exception as e:
                      print(f'âš ï¸ Space not found: {e}')
                      print(f'ğŸ”§ Creating new space...')
                      
                      try:
                          api.create_repo(
                              repo_id=space_name,
                              repo_type='space',
                              space_sdk='gradio',
                              private=False,
                              token=token
                          )
                          
                          api.upload_file(
                              path_or_fileobj='app.py',
                              path_in_repo='app.py',
                              repo_id=space_name,
                              repo_type='space',
                              token=token
                          )
                          
                          api.upload_file(
                              path_or_fileobj='requirements.txt',
                              path_in_repo='requirements.txt',
                              repo_id=space_name,
                              repo_type='space',
                              token=token
                          )
                          
                          api.upload_folder(
                              folder_path='Model/',
                              path_in_repo='Model',
                              repo_id=space_name,
                              repo_type='space',
                              token=token
                          )
                          
                          print(f'âœ… Successfully created Space: {space_name}')
                          
                      except Exception as create_error:
                          print(f'âŒ Failed to create space: {create_error}')
                          sys.exit(1)
              
              if __name__ == "__main__":
                  main()
              EOF
              python deploy_script.py
    
          - name: ğŸ“Š Deployment Summary
            run: |
              echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âœ… Deployment Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**ğŸ¯ Target:** Hugging Face Spaces" >> $GITHUB_STEP_SUMMARY
              echo "**ğŸ“¦ Space Name:** ${{ env.HF_SPACE_NAME }}" >> $GITHUB_STEP_SUMMARY
              echo "**ğŸŒ¿ Branch:** Firman" >> $GITHUB_STEP_SUMMARY
              echo "**â° Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ“‹ Deployed Files:" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… app.py (Gradio application)" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… requirements.txt (Dependencies)" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… Model/personality_classifier.skops" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… Model/label_encoder.skops" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… Model/feature_names.skops" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ”— Access Your App:" >> $GITHUB_STEP_SUMMARY
              space_url="https://huggingface.co/spaces/${{ github.repository_owner }}/${{ env.HF_SPACE_NAME }}"
              echo "**ğŸŒ URL:** $space_url" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "*ğŸ¤– Deployed automatically by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
    
      notify:
        name: ğŸ“¢ Notify Deployment Status
        runs-on: ubuntu-latest
        needs: deploy
        if: always()
    
        steps:
          - name: ğŸ“¢ Deployment Notification
            run: |
              if [ "${{ needs.deploy.result }}" == "success" ]; then
                echo "âœ… Deployment to Hugging Face Spaces completed successfully!"
                space_url="https://huggingface.co/spaces/${{ github.repository_owner }}/${{ env.HF_SPACE_NAME }}"
                echo "ğŸŒ Your app should be available at: $space_url"
              else
                echo "âŒ Deployment failed. Please check the logs above."
                echo "ğŸ”§ Manual deployment may be required."
              fi
    